- hosts: all
  become: true
  any_errors_fatal: true
  gather_facts: true
  vars:
      precheck_id: elasticsearch_cpu_precheck
      max_cpu_threshold: 80
      check_interval_seconds: 30
      max_checks: 5
      cpu_results: []
      any_failure: false

  tasks:
      - name: Install required tools (if not already present)
        package:
            name: procps
            state: present

      - name: Perform CPU usage checks
        block:
            - name: Run CPU check {{ item }} of {{ max_checks }}
              shell: top -bn1 | grep "%Cpu(s)" | awk '{print $2 + $4}'
              register: cpu_result
              changed_when: false
              loop: "{{ range(1, max_checks + 1) | list }}"
              loop_control:
                  loop_var: item

            - name: Pause between CPU checks
              pause:
                  seconds: "{{ check_interval_seconds }}"
              when: item < max_checks
              loop: "{{ range(1, max_checks + 1) | list }}"
              loop_control:
                  loop_var: item

      - name: Extract and store CPU check results
        set_fact:
            cpu_results: "{{ cpu_result.results | map(attribute='stdout') | map('float') | list }}"
            any_failure: "{{ cpu_result.results | map(attribute='stdout') | map('float') | select('>', max_cpu_threshold) | list | length > 0 }}"

      - name: Display each CPU check result
        debug:
            msg: "Check {{ item.0 + 1 }}/{{ max_checks }}: CPU usage was {{ item.1 }}% (threshold: {{ max_cpu_threshold }}%)"
        with_indexed_items: "{{ cpu_results }}"

      - name: Display summary of all checks
        debug:
            msg:
                - "Precheck ID: {{ precheck_id }}"
                - "All CPU measurements: {{ cpu_results }}"
                - "Max CPU usage: {{ cpu_results | max }}"
                - "Min CPU usage: {{ cpu_results | min }}"
                - "Avg CPU usage: {{ (cpu_results | sum) / (cpu_results | length) | round(2) }}"

      - name: Fail if CPU threshold was exceeded during any check
        fail:
            msg: "Precheck [{{ precheck_id }}] failed: CPU usage exceeded {{ max_cpu_threshold }}% during one or more checks."
        when: any_failure | bool
