var u=Object.defineProperty;var h=(s,e,t)=>e in s?u(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var c=(s,e,t)=>h(s,typeof e!="symbol"?e+"":e,t);import{r as i}from"./chunk-HA7DTUK3-DrNZtXfs.js";import{U as d}from"./http-dO_zUEib.js";import{c as f}from"./middleware-BV1xb2r4.js";class m{constructor(e,t={}){c(this,"socket",null);c(this,"url");c(this,"eventHandlers",{});c(this,"isConnected",!1);c(this,"reconnect");c(this,"reconnectInterval");c(this,"maxRetries");c(this,"retryCount",0);c(this,"reconnectTimer");this.url=e,this.reconnect=t.reconnect??!0,this.reconnectInterval=t.reconnectInterval??3e3,this.maxRetries=t.maxRetries??1/0}connect(){this.socket=new WebSocket(this.url),this.socket.addEventListener("open",()=>{this.isConnected=!0,this.retryCount=0,this.emitLocal("connect")}),this.socket.addEventListener("message",e=>{try{const t=JSON.parse(e.data);this.emitLocal(t.type,t)}catch{console.warn("Invalid WebSocket message:",e.data)}}),this.socket.addEventListener("close",()=>{this.isConnected=!1,this.emitLocal("disconnect"),this.reconnect&&this.retryCount<this.maxRetries?this.scheduleReconnect():this.retryCount>=this.maxRetries&&this.emitLocal("reconnect_failed")}),this.socket.addEventListener("error",e=>{this.emitLocal("error",e)})}disconnect(){var e;this.reconnect=!1,this.reconnectTimer&&clearTimeout(this.reconnectTimer),(e=this.socket)==null||e.close()}emit(e,t){if(!this.isConnected||!this.socket)return;const n=JSON.stringify({type:e,data:t});this.socket.send(n)}on(e,t){this.eventHandlers[e]||(this.eventHandlers[e]=[]),this.eventHandlers[e].push(t)}off(e,t){var n;t?this.eventHandlers[e]=((n=this.eventHandlers[e])==null?void 0:n.filter(r=>r!==t))||[]:delete this.eventHandlers[e]}emitLocal(e,...t){var n;(n=this.eventHandlers[e])==null||n.forEach(r=>r(...t))}scheduleReconnect(){this.retryCount++,this.emitLocal("reconnect_attempt",this.retryCount),this.reconnectTimer=setTimeout(()=>{this.connect()},this.reconnectInterval)}}const k=f(s=>({socket:null,isConnected:!1,connect:()=>{const e=new m(d.SOCKET_BASE_URL);e.connect(),e.on("connect",()=>s({isConnected:!0})),e.on("disconnect",()=>s({isConnected:!1})),s({socket:e})},disconnect:()=>{s(e=>{var t;return(t=e.socket)==null||t.disconnect(),{socket:null,isConnected:!1}})}})),C=(s,e=1e3,t=3e3)=>{const n=i.useRef(null),r=i.useRef(Date.now()),o=(...a)=>{const l=Date.now();n.current&&clearTimeout(n.current),l-r.current>=t?(r.current=l,s(...a)):n.current=setTimeout(()=>{r.current=Date.now(),s(...a)},e)};return i.useEffect(()=>()=>{n.current&&clearTimeout(n.current)},[]),o},E=(s,e,t=!1)=>{const{socket:n}=k(),r=C(e,1e3,1500);return i.useEffect(()=>{if(!n)return;const o=t?r:e;return n.on(s,o),()=>{n.off(s,o)}},[n]),{}};export{E as a,k as u};
